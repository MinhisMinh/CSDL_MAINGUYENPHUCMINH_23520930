/*
DELETE FROM

DROP TABLE

ALTER TABLE
DROP CONSTRAINT 

DROP TRIGGER
*/

CREATE DATABASE THUCHANH1
GO

SET DATEFORMAT DMY
USE THUCHANH1

--Tao bang  NHASANXUAT--
CREATE TABLE NHASANXUAT
(
	MANSX CHAR(6) PRIMARY KEY, 
	TENNSX VARCHAR(50),
	NUOCTS VARCHAR(30),
	NAMTL INT,
);
GO

-- TAO BANG SANPHAM --
CREATE TABLE SANPHAM
(
	MASP CHAR(5) PRIMARY KEY, 
	MANSX CHAR(6) FOREIGN KEY REFERENCES NHASANXUAT(MANSX),
	TENSP VARCHAR(30),
	MAU VARCHAR(20),
	LOAISP VARCHAR(15),
	GIA MONEY
);
GO

--TAO BANG PHIEUNHAP--
CREATE TABLE PHIEUNHAP
(
	MAPN CHAR(5) PRIMARY KEY,
	MANSX CHAR(6) FOREIGN KEY REFERENCES NHASANXUAT(MANSX),
	TRIGIA MONEY,
	NGNHAP SMALLDATETIME
);
GO

--TAO BANG CTPN--
CREATE TABLE CTPN
(
	MAPN CHAR(5) FOREIGN KEY REFERENCES PHIEUNHAP(MAPN),
	MASP CHAR(5) FOREIGN KEY REFERENCES SANPHAM(MASP), 
	SOLUONG INT
	PRIMARY KEY(MAPN,MASP)
);
GO

--INSERT DATA
INSERT INTO NHASANXUAT VALUES ('NSX001','Apple','My',1976),('NSX002','Huawei','Trung Quoc',1987),('NSX003','Xiaomi','Trung Quoc',2010)
INSERT INTO SANPHAM VALUES ('SP001','NSX001','iPhone 6','Trang','Dien thoai',8000000),('SP002','NSX002','Mate 40 Pro','Den','Dien thoai',15000000),('SP003','NSX001','MacBook Air M1','Hong','May tinh',21000000)
INSERT INTO PHIEUNHAP VALUES ('PN001','NSX001',145000000,'15/03/2024'),('PN002','NSX002',150000000,'02/05/2024'),('PN003','NSX001',88000000,'26/05/2024')
INSERT INTO CTPN VALUES ('PN001','SP001',5),('PN001','SP003',5),('PN002','SP002',10),('PN003','SP001',11)

DELETE FROM CTPN
DELETE FROM PHIEUNHAP
--C3:
ALTER TABLE SANPHAM
ADD CONSTRAINT CHK_GIANIEMYET CHECK( LOAISP != 'May tinh' OR GIA > 8000000)

--C4:
CREATE OR ALTER TRIGGER TRG_PHIEUNHAP ON PHIEUNHAP AFTER INSERT
AS 
BEGIN
	DECLARE @NGNHAP SMALLDATETIME, @MANSX CHAR(6), @NAMTL INT
	SELECT @NGNHAP = NGNHAP, @MANSX = MANSX FROM inserted
	SELECT @NAMTL = NAMTL FROM NHASANXUAT WHERE @MANSX = MANSX
	IF(YEAR(@NGNHAP) >= @NAMTL)
	BEGIN
		PRINT ('SUCCESSFUL')
	END
	ELSE
	BEGIN
		RAISERROR('ERROR',16,1)
		ROLLBACK TRAN
	END
END

SELECT *
FROM PHIEUNHAP


--C5:
SELECT MANSX, TENNSX
FROM NHASANXUAT
WHERE NUOCTS = 'Trung Quoc' 

SELECT *
FROM NHASANXUAT
SELECT *
FROM SANPHAM
SELECT *
FROM PHIEUNHAP

--C6:
SELECT SP.MASP,SP.TENSP
FROM SANPHAM SP
INNER JOIN CTPN ON CTPN.MASP = SP.MASP
INNER JOIN PHIEUNHAP PN ON PN.MAPN = CTPN.MAPN
WHERE MONTH(PN.NGNHAP) = 5 AND YEAR(PN.NGNHAP) = 2024
ORDER BY DAY(PN.NGNHAP) ASC
GO

--C7:
SELECT NSX.MANSX, NSX.TENNSX
FROM NHASANXUAT NSX
WHERE MANSX IN 
	(
		SELECT MANSX
		FROM SANPHAM
		GROUP BY MANSX
	)
--C8:
SELECT PN.MAPN, PN.NGNHAP
FROM PHIEUNHAP PN
WHERE YEAR(PN.NGNHAP) = 2024 AND NOT EXISTS
	(
		SELECT *
		FROM NHASANXUAT NSX
		WHERE NSX.NUOCTS = 'My' AND NOT EXISTS
			(
				SELECT *
				FROM CTPN
				WHERE PN.MANSX = NSX.MANSX AND PN.MAPN = CTPN.MAPN
			)
	)

--C9:
SELECT CTPN.MAPN, NSX.TENNSX, SUM(SOLUONG) AS Tong_So_Luong
FROM CTPN
INNER JOIN PHIEUNHAP PN ON PN.MAPN = CTPN.MAPN
INNER JOIN NHASANXUAT NSX ON PN.MANSX = NSX.MANSX
GROUP BY CTPN.MAPN, NSX.TENNSX